# AIRecipe Nginx 安全配置增强版
# 请将此配置替换到 /etc/nginx/sites-enabled/ 中的配置文件

# ====================================
# 1. Cloudflare 真实 IP 配置
# ====================================
# 获取客户端真实 IP (通过 Cloudflare CF-Connecting-IP header)
# Cloudflare IP 列表参考: https://www.cloudflare.com/ips/

# IPv4
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 131.0.72.0/22;

# IPv6 (可选)
set_real_ip_from 2400:cb00::/32;
set_real_ip_from 2606:4700::/32;
set_real_ip_from 2803:f800::/32;
set_real_ip_from 2405:b500::/32;
set_real_ip_from 2405:8100::/32;
set_real_ip_from 2a06:98c0::/29;
set_real_ip_from 2c0f:f248::/32;

# 使用 Cloudflare 提供的真实 IP header
real_ip_header CF-Connecting-IP;

# ====================================
# 2. 速率限制区域定义
# ====================================
# 限制正常请求频率 (每秒 30 次,足够 Next.js 首次加载)
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;

# 限制敏感路径访问频率 (每秒 1 次)
limit_req_zone $binary_remote_addr zone=sensitive_limit:10m rate=1r/s;

# 限制 API 请求频率 (每秒 10 次,食谱生成需要多次请求)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# ====================================
# 3. 主服务器配置
# ====================================
server {
    server_name wusimpl.fun www.wusimpl.fun;

    # 日志配置
    access_log /var/log/nginx/airecipe_access.log;
    error_log /var/log/nginx/airecipe_error.log;

    # 客户端最大请求体大小
    client_max_body_size 10M;

    # ====================================
    # 安全增强: 阻止敏感文件访问
    # ====================================
    # 阻止 .env 文件访问
    location ~* \.(env|env\..*|bak|backup|sql|dump)$ {
        deny all;
        access_log /var/log/nginx/blocked_requests.log;
        return 403;
    }

    # 阻止 .git 目录访问
    location ~ /\.git {
        deny all;
        access_log /var/log/nginx/blocked_requests.log;
        return 403;
    }

    # 阻止 PHP 相关扫描
    location ~* \.(php|php3|php4|php5|phtml)$ {
        deny all;
        access_log /var/log/nginx/blocked_requests.log;
        return 403;
    }

    # 阻止常见扫描路径
    location ~* ^/(phpinfo|info\.php|test\.php|_profiler|wp-admin|wp-login) {
        deny all;
        access_log /var/log/nginx/blocked_requests.log;
        return 403;
    }

    # ====================================
    # 后端 API 代理
    # ====================================
    location /api/ {
        # 应用速率限制
        limit_req zone=api_limit burst=10 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:8089;
        proxy_http_version 1.1;

        # WebSocket 和 SSE 支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # 转发真实 IP (Cloudflare 模式)
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;

        # SSE 流式输出超时配置
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;

        # 禁用缓冲,支持流式输出
        proxy_buffering off;
        proxy_cache off;
    }

    # ====================================
    # 前端应用代理
    # ====================================
    # 静态资源不限速 (Next.js chunks, images, fonts 等)
    location ~* ^/_next/static/ {
        proxy_pass http://127.0.0.1:8090;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 静态资源缓存
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # 其他静态资源 (favicon, robots.txt 等)
    location ~* \.(ico|jpg|jpeg|png|gif|svg|woff|woff2|ttf|eot|css)$ {
        proxy_pass http://127.0.0.1:8090;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # 静态资源缓存
        add_header Cache-Control "public, max-age=86400";
    }

    # 前端页面请求 (应用宽松的速率限制)
    location / {
        # 宽松的速率限制: 每秒 30 次, burst 50 (足够 Next.js 首次加载)
        limit_req zone=general_limit burst=50 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:8090;
        proxy_http_version 1.1;

        # Next.js HMR(热更新)支持
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # 转发真实 IP (Cloudflare 模式)
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
    }

    # SSL 配置 (Certbot 自动生成)
    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/wusimpl.fun/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/wusimpl.fun/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# ====================================
# HTTP 重定向到 HTTPS (Certbot 自动生成)
# ====================================
server {
    if ($host = www.wusimpl.fun) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = wusimpl.fun) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name wusimpl.fun www.wusimpl.fun;
    return 404; # managed by Certbot
}
